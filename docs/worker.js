(()=>{"use strict";var e={939:e=>{var t,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(n,r){function i(){void 0!==o&&e.removeListener("error",o),n([].slice.call(arguments))}var o;"error"!==t&&(o=function(n){e.removeListener(t,i),r(n)},e.once("error",o)),e.once(t,i)}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var s=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,n,r){var i,o,s,c;if(a(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(i=u(e))>0&&s.length>i&&!s.warned){s.warned=!0;var f=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");f.name="MaxListenersExceededWarning",f.emitter=e,f.type=t,f.count=s.length,c=f,console&&console.warn&&console.warn(c)}return e}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=f.bind(r);return i.listener=n,r.wrapFn=i,i}function l(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):g(i,i.length)}function h(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");s=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return u(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,o=this._events;if(void 0!==o)i=i&&void 0===o.error;else if(!i)return!1;if(i){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var u=o[e];if(void 0===u)return!1;if("function"==typeof u)r(u,this,t);else{var c=u.length,f=g(u,c);for(n=0;n<c;++n)r(f[n],this,t)}return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return a(t),this.on(e,p(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,p(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,i,o,s;if(a(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return l(this,e,!0)},o.prototype.rawListeners=function(e){return l(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},o.prototype.listenerCount=h,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},487:(e,t,n)=>{function r(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),r(n(953)),r(n(573))},953:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),(n=t.MsgType||(t.MsgType={}))[n.RpcCall=1]="RpcCall",n[n.RpcRespData=2]="RpcRespData",n[n.RpcRespErr=3]="RpcRespErr",n[n.Custom=4]="Custom",n[n.Ready=5]="Ready"},573:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){e.done?i(e.value):new n((function(t){t(e.value)})).then(s,a)}u((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(939),o=n(651),s=n(953),a=e=>e();class u extends i.EventEmitter{constructor(e={}){super(),this._sendMessageCB=null,this._inactiveRecvQueue=null,this._inactiveSendQueue=null,this._waitForReadyMessage=!1,this._implMap=new Map,this._forwarders=new Map,this._pendingCalls=new Map,this._nextRequestId=1;const{logger:t=console,sendMessage:n=null,callWrapper:r=a}=e;this._logger=t,this._callWrapper=r,this.setSendMessage(n)}receiveMessage(e){this._inactiveRecvQueue?this._inactiveRecvQueue.push(e):this._dispatch(e)}queueIncoming(){this._inactiveRecvQueue||(this._inactiveRecvQueue=[])}processIncoming(){this._inactiveRecvQueue&&(h(this._inactiveRecvQueue,this._dispatch.bind(this)),this._inactiveRecvQueue=null)}setSendMessage(e){this._sendMessageCB=e,this._sendMessageCB?this._processOutgoing():this._queueOutgoing()}queueOutgoingUntilReadyMessage(){this._waitForReadyMessage=!0,this._queueOutgoing()}sendReadyMessage(){return this._sendMessage({mtype:s.MsgType.Ready})}postMessage(e){return this.postMessageForward("",e)}postMessageForward(e,t){return r(this,void 0,void 0,(function*(){const n={mtype:s.MsgType.Custom,data:t};e&&(n.mdest=e),yield this._sendMessage(n)}))}registerImpl(e,t,n){if(this._implMap.has(e))throw new Error(`Rpc.registerImpl has already been called for ${e}`);const r=e=>t[e.meth](...e.args);if(n){const t=n.getType();if(!(t instanceof o.TIface))throw new Error("Rpc.registerImpl requires a Checker for an interface");const i={};for(const e of t.props)e.ttype instanceof o.TFunc&&(i[e.name]=n.methodArgs(e.name));this._implMap.set(e,{name:e,invokeImpl:r,argsCheckers:i})}else this._implMap.set(e,{name:e,invokeImpl:r,argsCheckers:null})}registerForwarder(e,t,n=("*"===e?"*":"")){const r="*"===n;this._forwarders.set(e,{name:"[FWD]"+e,argsCheckers:null,invokeImpl:e=>t.forwardCall(Object.assign({},e,{mdest:r?e.mdest:n})),forwardMessage:e=>t.forwardMessage(Object.assign({},e,{mdest:r?e.mdest:n}))})}unregisterForwarder(e){this._forwarders.delete(e)}unregisterImpl(e){this._implMap.delete(e)}getStub(e,t){const n=this._parseName(e);return this.getStubForward(n.forwarder,n.name,t)}getStubForward(e,t,n){if(n){const r=n.getType();if(!(r instanceof o.TIface))throw new Error("Rpc.getStub requires a Checker for an interface");const i={};for(const s of r.props)if(s.ttype instanceof o.TFunc){const r=n.methodResult(s.name);i[s.name]=(...n)=>this._makeCall(t,s.name,n,r,e)}return i}return new Proxy({},{get:(n,r,i)=>{if("then"!==r)return(...n)=>this._makeCall(t,r,n,l,e)}})}registerFunc(e,t){return this.registerImpl(e,{invoke:t},p)}unregisterFunc(e){return this.unregisterImpl(e)}callRemoteFunc(e,...t){const n=this._parseName(e);return this.callRemoteFuncForward(n.forwarder,n.name,...t)}callRemoteFuncForward(e,t,...n){return this._makeCall(t,"invoke",n,l,e)}forwardCall(e){return this._makeCall(e.iface,e.meth,e.args,l,e.mdest||"")}forwardMessage(e){return this.postMessageForward(e.mdest||"",e.data)}_queueOutgoing(){this._inactiveSendQueue||(this._inactiveSendQueue=[])}_processOutgoing(){this._inactiveSendQueue&&this._sendMessageCB&&!this._waitForReadyMessage&&(h(this._inactiveSendQueue,this._sendMessageOrReject.bind(this,this._sendMessageCB)),this._inactiveSendQueue=null)}_sendMessage(e){if(!this._inactiveSendQueue)return this._sendMessageOrReject(this._sendMessageCB,e);this._inactiveSendQueue.push(e)}_sendMessageOrReject(e,t){if(this._logger.info){const e=t.mtype===s.MsgType.RpcCall?": "+this._callDesc(t):"";this._logger.info(`Rpc sending ${s.MsgType[t.mtype]}${e}`)}return g((()=>e(t)),(e=>this._sendReject(t,e)))}_sendReject(e,t){const n=new c("RPC_SEND_FAILED",`Send failed: ${t.message}`);if(e.mtype===s.MsgType.RpcCall&&void 0!==e.reqId){const t=this._pendingCalls.get(e.reqId);t&&(this._pendingCalls.delete(e.reqId),t.reject(n))}throw this.emit("error",n),n}_makeCallRaw(e,t,n,r,i){return new Promise(((o,a)=>{const u=this._nextRequestId++,c={reqId:u,iface:e,meth:t,resolve:o,reject:a,resultChecker:r};this._pendingCalls.set(u,c),this._info(c,"RPC_CALLING");const f={mtype:s.MsgType.RpcCall,reqId:u,iface:e,meth:t,args:n};i&&(f.mdest=i),g((()=>this._sendMessage(f)),a)}))}_makeCall(e,t,n,r,i){return this._callWrapper((()=>this._makeCallRaw(e,t,n,r,i)))}_dispatch(e){switch(e.mtype){case s.MsgType.RpcCall:return void this._onMessageCall(e);case s.MsgType.RpcRespData:case s.MsgType.RpcRespErr:return void this._onMessageResp(e);case s.MsgType.Custom:return void this._onCustomMessage(e);case s.MsgType.Ready:this._waitForReadyMessage=!1;try{this._processOutgoing()}catch(e){}return}}_onCustomMessage(e){if(e.mdest){const t=this._forwarders.get(e.mdest)||this._forwarders.get("*");t?t.forwardMessage(e):this._warn(null,"RPC_UNKNOWN_FORWARD_DEST","Unknown forward destination")}else this.emit("message",e.data)}_onMessageCall(e){return r(this,void 0,void 0,(function*(){let t,n;if(e.mdest){if(t=this._forwarders.get(e.mdest)||this._forwarders.get("*"),!t)return this._failCall(e,"RPC_UNKNOWN_FORWARD_DEST","Unknown forward destination")}else if(t=this._implMap.get(e.iface),!t)return this._failCall(e,"RPC_UNKNOWN_INTERFACE","Unknown interface");if(t.argsCheckers){if(!t.argsCheckers.hasOwnProperty(e.meth))return this._failCall(e,"RPC_UNKNOWN_METHOD","Unknown method");const n=t.argsCheckers[e.meth];try{n.check(e.args)}catch(t){return this._failCall(e,"RPC_INVALID_ARGS",`Invalid args: ${t.message}`)}}if(void 0===e.reqId)return this._failCall(e,"RPC_MISSING_REQID","Missing request id");this._info(e,"RPC_ONCALL");try{n=yield t.invokeImpl(e)}catch(t){return this._failCall(e,t.code,t.message,"RPC_ONCALL_ERROR")}return this._info(e,"RPC_ONCALL_OK"),this._sendResponse(e.reqId,n)}))}_failCall(e,t,n,i){return r(this,void 0,void 0,(function*(){if(this._warn(e,i||t,n),void 0!==e.reqId){const r={mtype:s.MsgType.RpcRespErr,reqId:e.reqId,mesg:n,code:t};yield this._sendMessage(r)}}))}_sendResponse(e,t){return r(this,void 0,void 0,(function*(){const n={mtype:s.MsgType.RpcRespData,reqId:e,data:t};yield this._sendMessage(n)}))}_onMessageResp(e){const t=this._pendingCalls.get(e.reqId);if(this._pendingCalls.delete(e.reqId),t){if(e.mtype===s.MsgType.RpcRespErr)return this._info(t,"RPC_RESULT_ERROR",e.mesg),t.reject(new c(e.code,e.mesg));try{t.resultChecker.check(e.data)}catch(e){return this._warn(t,"RPC_RESULT_INVALID",e.message),t.reject(new c("RPC_INVALID_RESULT",`Implementation produced invalid result: ${e.message}`))}this._info(t,"RPC_RESULT_OK"),t.resolve(e.data)}else this._warn(null,"RPC_UNKNOWN_REQID",`Response to unknown reqId ${e.reqId}`)}_info(e,t,n){if(this._logger.info){const r=n?" "+n:"";this._logger.info(`Rpc for ${this._callDesc(e)}: ${t}${r}`)}}_warn(e,t,n){if(this._logger.warn){const r=n?" "+n:"";this._logger.warn(`Rpc for ${this._callDesc(e)}: ${t}${r}`)}}_callDesc(e){return e?`${e.iface}.${e.meth}#${e.reqId||"-"}`:"?"}_parseName(e){const t=e.lastIndexOf("@");return-1===t?{forwarder:"",name:e}:{name:e.substr(0,t),forwarder:e.substr(t+1)}}}t.Rpc=u;class c extends Error{constructor(e,t){super(t),this.code=e}}t.ErrorWithCode=c;const f=o.iface([],{invoke:o.func("any")}),{IAnyFunc:p}=o.createCheckers({IAnyFunc:f}),l=p.methodResult("invoke");function h(e,t){let n=0;try{for(;n<e.length;)t(e[n++])}finally{e.splice(0,n)}}function g(e,t){try{const n=e();if(n)return n.catch(t)}catch(e){return t(e)}}},651:function(e,t,n){var r=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r};Object.defineProperty(t,"__esModule",{value:!0}),t.Checker=t.createCheckers=void 0;var i=n(266),o=n(108),s=n(266);Object.defineProperty(t,"TArray",{enumerable:!0,get:function(){return s.TArray}}),Object.defineProperty(t,"TEnumType",{enumerable:!0,get:function(){return s.TEnumType}}),Object.defineProperty(t,"TEnumLiteral",{enumerable:!0,get:function(){return s.TEnumLiteral}}),Object.defineProperty(t,"TFunc",{enumerable:!0,get:function(){return s.TFunc}}),Object.defineProperty(t,"TIface",{enumerable:!0,get:function(){return s.TIface}}),Object.defineProperty(t,"TLiteral",{enumerable:!0,get:function(){return s.TLiteral}}),Object.defineProperty(t,"TName",{enumerable:!0,get:function(){return s.TName}}),Object.defineProperty(t,"TOptional",{enumerable:!0,get:function(){return s.TOptional}}),Object.defineProperty(t,"TParam",{enumerable:!0,get:function(){return s.TParam}}),Object.defineProperty(t,"TParamList",{enumerable:!0,get:function(){return s.TParamList}}),Object.defineProperty(t,"TProp",{enumerable:!0,get:function(){return s.TProp}}),Object.defineProperty(t,"TTuple",{enumerable:!0,get:function(){return s.TTuple}}),Object.defineProperty(t,"TType",{enumerable:!0,get:function(){return s.TType}}),Object.defineProperty(t,"TUnion",{enumerable:!0,get:function(){return s.TUnion}}),Object.defineProperty(t,"TIntersection",{enumerable:!0,get:function(){return s.TIntersection}}),Object.defineProperty(t,"array",{enumerable:!0,get:function(){return s.array}}),Object.defineProperty(t,"enumlit",{enumerable:!0,get:function(){return s.enumlit}}),Object.defineProperty(t,"enumtype",{enumerable:!0,get:function(){return s.enumtype}}),Object.defineProperty(t,"func",{enumerable:!0,get:function(){return s.func}}),Object.defineProperty(t,"iface",{enumerable:!0,get:function(){return s.iface}}),Object.defineProperty(t,"lit",{enumerable:!0,get:function(){return s.lit}}),Object.defineProperty(t,"name",{enumerable:!0,get:function(){return s.name}}),Object.defineProperty(t,"opt",{enumerable:!0,get:function(){return s.opt}}),Object.defineProperty(t,"param",{enumerable:!0,get:function(){return s.param}}),Object.defineProperty(t,"tuple",{enumerable:!0,get:function(){return s.tuple}}),Object.defineProperty(t,"union",{enumerable:!0,get:function(){return s.union}}),Object.defineProperty(t,"intersection",{enumerable:!0,get:function(){return s.intersection}}),Object.defineProperty(t,"BasicType",{enumerable:!0,get:function(){return s.BasicType}});var a=n(108);Object.defineProperty(t,"VError",{enumerable:!0,get:function(){return a.VError}}),t.createCheckers=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=Object.assign.apply(Object,r([{},i.basicTypes],e)),o={},s=0,a=e;s<a.length;s++)for(var c=a[s],f=0,p=Object.keys(c);f<p.length;f++){var l=p[f];o[l]=new u(n,c[l])}return o};var u=function(){function e(e,t,n){if(void 0===n&&(n="value"),this.suite=e,this.ttype=t,this._path=n,this.props=new Map,t instanceof i.TIface)for(var r=0,o=t.props;r<o.length;r++){var s=o[r];this.props.set(s.name,s.ttype)}this.checkerPlain=this.ttype.getChecker(e,!1),this.checkerStrict=this.ttype.getChecker(e,!0)}return e.prototype.setReportedPath=function(e){this._path=e},e.prototype.check=function(e){return this._doCheck(this.checkerPlain,e)},e.prototype.test=function(e){return this.checkerPlain(e,new o.NoopContext)},e.prototype.validate=function(e){return this._doValidate(this.checkerPlain,e)},e.prototype.strictCheck=function(e){return this._doCheck(this.checkerStrict,e)},e.prototype.strictTest=function(e){return this.checkerStrict(e,new o.NoopContext)},e.prototype.strictValidate=function(e){return this._doValidate(this.checkerStrict,e)},e.prototype.getProp=function(t){var n=this.props.get(t);if(!n)throw new Error("Type has no property "+t);return new e(this.suite,n,this._path+"."+t)},e.prototype.methodArgs=function(t){var n=this._getMethod(t);return new e(this.suite,n.paramList)},e.prototype.methodResult=function(t){var n=this._getMethod(t);return new e(this.suite,n.result)},e.prototype.getArgs=function(){if(!(this.ttype instanceof i.TFunc))throw new Error("getArgs() applied to non-function");return new e(this.suite,this.ttype.paramList)},e.prototype.getResult=function(){if(!(this.ttype instanceof i.TFunc))throw new Error("getResult() applied to non-function");return new e(this.suite,this.ttype.result)},e.prototype.getType=function(){return this.ttype},e.prototype._doCheck=function(e,t){if(!e(t,new o.NoopContext)){var n=new o.DetailContext;throw e(t,n),n.getError(this._path)}},e.prototype._doValidate=function(e,t){if(e(t,new o.NoopContext))return null;var n=new o.DetailContext;return e(t,n),n.getErrorDetail(this._path)},e.prototype._getMethod=function(e){var t=this.props.get(e);if(!t)throw new Error("Type has no property "+e);if(!(t instanceof i.TFunc))throw new Error("Property "+e+" is not a method");return t},e}();t.Checker=u},266:function(e,t,n){var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),t.basicTypes=t.BasicType=t.TParamList=t.TParam=t.param=t.TFunc=t.func=t.TProp=t.TOptional=t.opt=t.TIface=t.iface=t.TEnumLiteral=t.enumlit=t.TEnumType=t.enumtype=t.TIntersection=t.intersection=t.TUnion=t.union=t.TTuple=t.tuple=t.TArray=t.array=t.TLiteral=t.lit=t.TName=t.name=t.TType=void 0;var o=n(108),s=function(){};function a(e){return"string"==typeof e?c(e):e}function u(e,t){var n=e[t];if(!n)throw new Error("Unknown type "+t);return n}function c(e){return new f(e)}t.TType=s,t.name=c;var f=function(e){function t(t){var n=e.call(this)||this;return n.name=t,n._failMsg="is not a "+t,n}return i(t,e),t.prototype.getChecker=function(e,n,r){var i=this,o=u(e,this.name),s=o.getChecker(e,n,r);return o instanceof R||o instanceof t?s:function(e,t){return!!s(e,t)||t.fail(null,i._failMsg,0)}},t}(s);t.TName=f,t.lit=function(e){return new p(e)};var p=function(e){function t(t){var n=e.call(this)||this;return n.value=t,n.name=JSON.stringify(t),n._failMsg="is not "+n.name,n}return i(t,e),t.prototype.getChecker=function(e,t){var n=this;return function(e,t){return e===n.value||t.fail(null,n._failMsg,-1)}},t}(s);t.TLiteral=p,t.array=function(e){return new l(a(e))};var l=function(e){function t(t){var n=e.call(this)||this;return n.ttype=t,n}return i(t,e),t.prototype.getChecker=function(e,t){var n=this.ttype.getChecker(e,t);return function(e,t){if(!Array.isArray(e))return t.fail(null,"is not an array",0);for(var r=0;r<e.length;r++)if(!n(e[r],t))return t.fail(r,null,1);return!0}},t}(s);t.TArray=l,t.tuple=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new h(e.map((function(e){return a(e)})))};var h=function(e){function t(t){var n=e.call(this)||this;return n.ttypes=t,n}return i(t,e),t.prototype.getChecker=function(e,t){var n=this.ttypes.map((function(n){return n.getChecker(e,t)})),r=function(e,t){if(!Array.isArray(e))return t.fail(null,"is not an array",0);for(var r=0;r<n.length;r++)if(!n[r](e[r],t))return t.fail(r,null,1);return!0};return t?function(e,t){return!!r(e,t)&&(e.length<=n.length||t.fail(n.length,"is extraneous",2))}:r},t}(s);t.TTuple=h,t.union=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new g(e.map((function(e){return a(e)})))};var g=function(e){function t(t){var n=e.call(this)||this;n.ttypes=t;var r=t.map((function(e){return e instanceof f||e instanceof p?e.name:null})).filter((function(e){return e})),i=t.length-r.length;return r.length?(i>0&&r.push(i+" more"),n._failMsg="is none of "+r.join(", ")):n._failMsg="is none of "+i+" types",n}return i(t,e),t.prototype.getChecker=function(e,t){var n=this,r=this.ttypes.map((function(n){return n.getChecker(e,t)}));return function(e,t){for(var i=t.unionResolver(),o=0;o<r.length;o++)if(r[o](e,i.createContext()))return!0;return t.resolveUnion(i),t.fail(null,n._failMsg,0)}},t}(s);t.TUnion=g,t.intersection=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new y(e.map((function(e){return a(e)})))};var y=function(e){function t(t){var n=e.call(this)||this;return n.ttypes=t,n}return i(t,e),t.prototype.getChecker=function(e,t){var n=new Set,r=this.ttypes.map((function(r){return r.getChecker(e,t,n)}));return function(e,t){return!!r.every((function(n){return n(e,t)}))||t.fail(null,null,0)}},t}(s);t.TIntersection=y,t.enumtype=function(e){return new d(e)};var d=function(e){function t(t){var n=e.call(this)||this;return n.members=t,n.validValues=new Set,n._failMsg="is not a valid enum value",n.validValues=new Set(Object.keys(t).map((function(e){return t[e]}))),n}return i(t,e),t.prototype.getChecker=function(e,t){var n=this;return function(e,t){return!!n.validValues.has(e)||t.fail(null,n._failMsg,0)}},t}(s);t.TEnumType=d,t.enumlit=function(e,t){return new m(e,t)};var m=function(e){function t(t,n){var r=e.call(this)||this;return r.enumName=t,r.prop=n,r._failMsg="is not "+t+"."+n,r}return i(t,e),t.prototype.getChecker=function(e,t){var n=this,r=u(e,this.enumName);if(!(r instanceof d))throw new Error("Type "+this.enumName+" used in enumlit is not an enum type");var i=r.members[this.prop];if(!r.members.hasOwnProperty(this.prop))throw new Error("Unknown value "+this.enumName+"."+this.prop+" used in enumlit");return function(e,t){return e===i||t.fail(null,n._failMsg,-1)}},t}(s);t.TEnumLiteral=m,t.iface=function(e,t){return new v(e,function(e){return Object.keys(e).map((function(t){return function(e,t){return t instanceof _?new w(e,t.ttype,!0):new w(e,a(t),!1)}(t,e[t])}))}(t))};var v=function(e){function t(t,n){var r=e.call(this)||this;return r.bases=t,r.props=n,r.propSet=new Set(n.map((function(e){return e.name}))),r}return i(t,e),t.prototype.getChecker=function(e,t,n){var r=this,i=this.bases.map((function(n){return u(e,n).getChecker(e,t)})),s=this.props.map((function(n){return n.ttype.getChecker(e,t)})),a=new o.NoopContext,c=this.props.map((function(e,t){return!e.isOpt&&!s[t](void 0,a)})),f=function(e,t){if("object"!=typeof e||null===e)return t.fail(null,"is not an object",0);for(var n=0;n<i.length;n++)if(!i[n](e,t))return!1;for(n=0;n<s.length;n++){var o=r.props[n].name,a=e[o];if(void 0===a){if(c[n])return t.fail(o,"is missing",1)}else if(!s[n](a,t))return t.fail(o,null,1)}return!0};if(!t)return f;var p=this.propSet;return n&&(this.propSet.forEach((function(e){return n.add(e)})),p=n),function(e,t){if(!f(e,t))return!1;for(var n in e)if(!p.has(n))return t.fail(n,"is extraneous",2);return!0}},t}(s);t.TIface=v,t.opt=function(e){return new _(a(e))};var _=function(e){function t(t){var n=e.call(this)||this;return n.ttype=t,n}return i(t,e),t.prototype.getChecker=function(e,t){var n=this.ttype.getChecker(e,t);return function(e,t){return void 0===e||n(e,t)}},t}(s);t.TOptional=_;var w=function(e,t,n){this.name=e,this.ttype=t,this.isOpt=n};t.TProp=w,t.func=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return new b(new T(t),a(e))};var b=function(e){function t(t,n){var r=e.call(this)||this;return r.paramList=t,r.result=n,r}return i(t,e),t.prototype.getChecker=function(e,t){return function(e,t){return"function"==typeof e||t.fail(null,"is not a function",0)}},t}(s);t.TFunc=b,t.param=function(e,t,n){return new C(e,a(t),Boolean(n))};var C=function(e,t,n){this.name=e,this.ttype=t,this.isOpt=n};t.TParam=C;var T=function(e){function t(t){var n=e.call(this)||this;return n.params=t,n}return i(t,e),t.prototype.getChecker=function(e,t){var n=this,r=this.params.map((function(n){return n.ttype.getChecker(e,t)})),i=new o.NoopContext,s=this.params.map((function(e,t){return!e.isOpt&&!r[t](void 0,i)})),a=function(e,t){if(!Array.isArray(e))return t.fail(null,"is not an array",0);for(var i=0;i<r.length;i++){var o=n.params[i];if(void 0===e[i]){if(s[i])return t.fail(o.name,"is missing",1)}else if(!r[i](e[i],t))return t.fail(o.name,null,1)}return!0};return t?function(e,t){return!!a(e,t)&&(e.length<=r.length||t.fail(r.length,"is extraneous",2))}:a},t}(s);t.TParamList=T;var R=function(e){function t(t,n){var r=e.call(this)||this;return r.validator=t,r.message=n,r}return i(t,e),t.prototype.getChecker=function(e,t){var n=this;return function(e,t){return!!n.validator(e)||t.fail(null,n.message,0)}},t}(s);t.BasicType=R,t.basicTypes={any:new R((function(e){return!0}),"is invalid"),number:new R((function(e){return"number"==typeof e}),"is not a number"),object:new R((function(e){return"object"==typeof e&&e}),"is not an object"),boolean:new R((function(e){return"boolean"==typeof e}),"is not a boolean"),string:new R((function(e){return"string"==typeof e}),"is not a string"),symbol:new R((function(e){return"symbol"==typeof e}),"is not a symbol"),void:new R((function(e){return null==e}),"is not void"),undefined:new R((function(e){return void 0===e}),"is not undefined"),null:new R((function(e){return null===e}),"is not null"),never:new R((function(e){return!1}),"is unexpected"),Date:new R(M("[object Date]"),"is not a Date"),RegExp:new R(M("[object RegExp]"),"is not a RegExp")};var O=Object.prototype.toString;function M(e){return function(t){return"object"==typeof t&&t&&O.call(t)===e}}"undefined"!=typeof Buffer&&(t.basicTypes.Buffer=new R((function(e){return Buffer.isBuffer(e)}),"is not a Buffer"));for(var P=function(e){t.basicTypes[e.name]=new R((function(t){return t instanceof e}),"is not a "+e.name)},k=0,j=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,ArrayBuffer];k<j.length;k++)P(j[k])},108:function(e,t){var n,r=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.DetailContext=t.NoopContext=t.VError=void 0;var i=function(e){function t(n,r){var i=e.call(this,r)||this;return i.path=n,Object.setPrototypeOf(i,t.prototype),i}return r(t,e),t}(Error);t.VError=i;var o=function(){function e(){}return e.prototype.fail=function(e,t,n){return!1},e.prototype.unionResolver=function(){return this},e.prototype.createContext=function(){return this},e.prototype.resolveUnion=function(e){},e}();t.NoopContext=o;var s=function(){function e(){this._propNames=[""],this._messages=[null],this._score=0}return e.prototype.fail=function(e,t,n){return this._propNames.push(e),this._messages.push(t),this._score+=n,!1},e.prototype.unionResolver=function(){return new a},e.prototype.resolveUnion=function(e){for(var t,n,r=null,i=0,o=e.contexts;i<o.length;i++){var s=o[i];(!r||s._score>=r._score)&&(r=s)}r&&r._score>0&&((t=this._propNames).push.apply(t,r._propNames),(n=this._messages).push.apply(n,r._messages))},e.prototype.getError=function(e){for(var t=[],n=this._propNames.length-1;n>=0;n--){var r=this._propNames[n];e+="number"==typeof r?"["+r+"]":r?"."+r:"";var o=this._messages[n];o&&t.push(e+" "+o)}return new i(e,t.join("; "))},e.prototype.getErrorDetail=function(e){for(var t=[],n=this._propNames.length-1;n>=0;n--){var r=this._propNames[n];e+="number"==typeof r?"["+r+"]":r?"."+r:"";var i=this._messages[n];i&&t.push({path:e,message:i})}var o=null;for(n=t.length-1;n>=0;n--)o&&(t[n].nested=[o]),o=t[n];return o},e}();t.DetailContext=s;var a=function(){function e(){this.contexts=[]}return e.prototype.createContext=function(){var e=new s;return this.contexts.push(e),e},e}()}},t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(()=>{const e=new(n(487).Rpc)({logger:{},sendMessage:postMessage});onmessage=t=>e.receiveMessage(t.data);const t=e.getStub("bank");e.registerFunc("runUserCode",(async e=>{const n=Function("transfer","getBalance",`return async function() { ${e} }`)(t.transfer,t.getBalance);await n()}))})()})();
//# sourceMappingURL=worker.js.map